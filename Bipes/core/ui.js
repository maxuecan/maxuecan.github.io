"use strict";function get(e){return document.querySelector(e)}function getIn(e,t){return e.querySelector(t)}function getAll(e,t){return get(e).querySelectorAll(t)}function style(e){return get(e).style}function fx(e,t){e.style.Transition=t}var $em=16;function panel(e,t){this.panel_=t,this.button=get(e),this.panel=get(t),this.button.onclick=()=>{this.showPanel()}}function account(e,t){panel.call(this,e,t),this.projectList=get("#ProjectList"),this.newProjectButton=get("#newProjectButton"),this.dom_username=get("#account_user"),this.dom_username.addEventListener("input",()=>{localStorage.setItem("account_user",this.dom_username.innerText)}),this.newProjectButton.onclick=()=>{this.newProject()},this.currentProject={uid:"",xml:""},this.projects=[],localStorage.account_user?this.dom_username.innerText=localStorage.account_user:localStorage.setItem("account_user","User")}function channelPanel(e,t){panel.call(this,e,t),this.bluetooth=get("#bluetoothButton"),this.serial=get("#serialButton"),this.network=get("#networkButton"),this.hidePanel=e=>{this.panel.id="",this.button.className=`icon ${e}`,UI.responsive.panels[this.panel_].show=!1},this.button.className=`icon ${Channel.mux.currentChannel}`,this.bluetooth.onclick=()=>{this.hidePanel("webbluetooth"),Channel.mux.switch("webbluetooth")},this.serial.onclick=()=>{this.hidePanel("webserial"),Channel.mux.switch("webserial")},this.network.onclick=()=>{this.hidePanel("websocket"),Channel.mux.switch("websocket")}}panel.prototype.showPanel=function(){let e=UI.responsive.panels[this.panel_];UI.responsive.closeZone._dom.classList.add("on"),$(".channel-panel").css("zIndex","999"),e.show?this.panel.id="":(this.panel.id="show","notify-panel"==e.from&&(UI.notify.container.id="")),e.show=!e.show,null!=this.onOpenPanel_&&this.onOpenPanel_()},account.prototype=Object.create(panel.prototype),account.prototype.restoreProjects=function(e){this.projects=e;for(const e in this.projects)localStorage[e]?this.listProject(e,this.projects[e]):delete this.projects[e]},account.prototype.openLastEdited=function(){this.currentProject.uid=Object.keys(this.projects).reduce((e,t)=>this.projects[e]>this.projects[t]?e:t),this.currentProject.xml=localStorage[this.currentProject.uid],getIn(this.projectList,`#${this.currentProject.uid}`).className="current";var e=UI.workspace.readWorkspace(this.currentProject.xml,!1);Blockly.Xml.domToWorkspace(Blockly.Xml.textToDom(e),Blockly.getMainWorkspace())},account.prototype.listProject=function(e,t){let o=this.getProjectName_(e);t=Tool.unix2date(t);let s=o.length>30?`${o.substring(0,27)}...`:o,n=new DOM("div",{id:e}),i=new DOM("div",{innerText:s,className:"runText",title:`Open project ${o}, created at ${t}`}).onclick(this,this.openProject,[e]),a=new DOM("span",{className:"icon",id:"trashIcon",title:`Delete project ${o}`}).onclick(this,this.deleteProject,[e]),r=new DOM("span",{className:"icon",id:"downloadIcon",title:`Download project ${o}`}).onclick(this,UI.workspace.saveXML,[e]),c=new DOM("div").append([r,a]);n.append([i,c]),this.projectList.append(n._dom)},account.prototype.openProject=function(e){if(""!=this.currentProject.uid){BlocklyStorage.backupBlocks_();try{getIn(this.projectList,`#${this.currentProject.uid}`).className=""}catch(e){}}let t=localStorage[e];this.currentProject.uid=e,this.currentProject.xml=t,getIn(this.projectList,`#${e}`).className="current",this.projects[e]=+new Date,BlocklyStorage.loadXml_(t,Blockly.getMainWorkspace()),Files.handleCurrentProject()},account.prototype.deleteProject=function(e){localStorage.removeItem(e),delete this.projects[e],localStorage.setItem("bipes_projects",JSON.stringify(this.projects)),getIn(this.projectList,`#${e}`).remove(),this.currentProject.uid==e&&(this.currentProject.uid="",this.currentProject.xml="",0==Object.keys(this.projects).length?this.newProject():this.openProject(Object.keys(this.projects).reduce((e,t)=>this.projects[e]>this.projects[t]?e:t)))},account.prototype.getProjectName_=function(e){let t=localStorage[e],o="",s=/<value name="project_description">.*?<\/value>/;if(s.test(t)){o=t.match(s)[0].match(/<field name="TEXT">(.*?)<\/field>/)[1].slice()}else o="My BIPES Project";return o},account.prototype.newProject=function(){if(""!=this.currentProject.uid){BlocklyStorage.backupBlocks_();try{getIn(this.projectList,`#${this.currentProject.uid}`).className=""}catch(e){}}let e=Tool.emptyXML(),t=Tool.uid();this.projects[t]=+new Date,localStorage.setItem("bipes_projects",JSON.stringify(this.projects)),localStorage.setItem(t,e),this.currentProject.uid=t,this.currentProject.xml=e,this.listProject(t,this.projects[t]),BlocklyStorage.loadXml_(e,Blockly.getMainWorkspace()),getIn(this.projectList,`#${t}`).className="current"},account.prototype.importProject=function(e){if(""!=this.currentProject.uid){BlocklyStorage.backupBlocks_();try{getIn(this.projectList,`#${this.currentProject.uid}`).className=""}catch(e){}}let t=Tool.uid();this.projects[t]=+new Date,localStorage.setItem("bipes_projects",JSON.stringify(this.projects)),localStorage.setItem(t,e),this.currentProject.uid=t,this.currentProject.xml=e,this.listProject(t,this.projects[t]),BlocklyStorage.loadXml_(e,Blockly.getMainWorkspace()),getIn(this.projectList,`#${t}`).className="current"},account.prototype.setCurrentProjectName_=function(e){let t=e.length>30?`${e.substring(0,27)}...`:e,o=getIn(this.projectList,`#${this.currentProject.uid}`),s=getIn(o,".runText");s.innerText=t,s.title=`Open project ${e}.`},account.prototype.onOpenPanel_=function(){this.setCurrentProjectName_(Tool.makeAName(Code.generateCode(),""))},channelPanel.prototype=Object.create(panel.prototype);class notify{constructor(){this.panel_=".notify-panel",this.container=get(".notify"),this.container.innerHTML="",this.panel=get(this.panel_),this.messages=[],this.logs=[],this.buffer_count=0,this.timeOut,this.timeOut2}}async function xhrGET(filename,responsetype,onsuccess,onfail){let xmlHTTP=new XMLHttpRequest;if(Channel.mux.isLocalFile){filename=filename.replace(/[\/\.]/g,"_");let regex_xml=/_(.*)_xml/,regex_json=/_(.*)_json/;if(regex_json.test(filename))window.addEventListener("load",()=>{onsuccess(JSON.parse(eval(`OFFLINE_${filename}`)))},!1);else if(regex_xml.test(filename)){var xml_=get(`#OFFLINE_${filename}`);null==xml_&&(xml_=get("#OFFLINE_toolbox_default_xml"),UI.notify.send(MSG.noToolbox)),onsuccess(xml_)}else alert(`Could not find ${filename} locally, please run at a server or use the live version at bipes.net.br/beta2/ui.`)}else xmlHTTP.open("GET",`${filename}`),xmlHTTP.responseType=responsetype,xmlHTTP.onload=function(){200==this.status?onsuccess("text"==responsetype||""==responsetype?this.responseText:"document"==responsetype?this.responseXML:this.response):null!=onfail?onfail():UI.notify.send(MSG.ErrorGET)},xmlHTTP.send()}notify.prototype.send=function(e){let t;console.log(`Notification: ${e}`),this.messages.push({timestamp:+new Date,message:e});let o=this.messages[this.messages.length-1];this.messages[this.messages.length-2]&&(t=this.messages[this.messages.length-2].message);let s=document.createElement("span");s.classList.add("icon"),s.id="trashIcon",o.div=document.createElement("span");let n=`[${Tool.unix2date(o.timestamp)}] ${e}`;o.div.title=n,o.div.appendChild(document.createTextNode(n)),o.div.appendChild(s),o.div.onclick=e=>{try{this.panel.removeChild(e.target.parentNode)}catch(e){}},this.panel.appendChild(o.div),UI.responsive.panels[this.panel_].show||(t==e&&"show"==this.container.id?(this.buffer_count=this.buffer_count+1,this.container.innerHTML=`(${this.buffer_count}x) ${n}`):(""==this.container.innerHTML?this.container.innerHTML=n:this.container.innerHTML=`${n}<hr>${this.container.innerHTML}`,this.buffer_count=0),this.container.id="show",window.clearTimeout(this.timeOut),this.timeOut=setTimeout(()=>{this.container.id="",this.buffer_count=0,this.timeOut2=setTimeout(()=>{this.container.innerHTML=""},150)},3e3))},notify.prototype.log=function(e){this.logs.push({timestamp:+new Date,message:e})};class responsive{constructor(){this.mobile=window.innerWidth<60*$em,this.body=get("body"),this.closeZone=new DOM("div",{id:"closeZone"}).onclick(this,this.hidePanels),this.panels={".toolbar":{from:"toolbar",x:22*$em,x2:0,y:7.5*$em,show:!1},".notify-panel":{from:"notify-panel",x:22*$em,x2:0,y:0,show:!1},".channel-panel":{from:"channel-panel",x:42.5*$em,x2:22*$em,y:24.5*$em,show:!1}},this.body.append(this.closeZone._dom),this.binded=!1,window.onresize=()=>{Files.resize(),this.mobile=window.innerWidth<60*$em}}}responsive.prototype.hidePanels=function(e){for(const e in this.panels)UI[this.panels[e].from].panel.id="",this.panels[e].show=!1;this.closeZone._dom.classList.remove("on"),$(".channel-panel").css("zIndex","-1")};class progress{constructor(){this.dom=get(".progress-bar"),this.div=document.createElement("div"),this.dom.appendChild(this.div),this.len}load(e,t){var o=100*e/t;this.div.style.width=o+"%"}remain(e){var t=100*(this.len-e)/this.len;this.div.style.width=t+"%"}start(e){this.len=e,this.dom.id="on"}end(){this.dom.id="",this.div.style.width="0%"}}class workspace{constructor(){window.location.pathname.includes("index.html")&&"file:"==window.location.protocol&&(alert("You will now be redirected to the offline version."),window.location.replace("index_offline.html")),this.defaultToolbox="default.xml",this.selector={value:"default_basic"},this.toolbarButton=get("#toolbarButton"),this.channel_connect=get("#channel_connect"),this.devices=[],xhrGET("devinfo/devinfo.json","json",e=>{this.devices=e.devices,/#(.)/.test(window.location.href)||this.change()}),this.websocket={url:get("#url"),pass:get("#password")},this.runButton={status:!0},this.connectButton=get("#connectButton"),this.saveButton=get("#saveButton"),this.loadButton=get("#loadXML"),this.connectButton.onclick=()=>{this.connectClick()},this.saveButton.onclick=()=>{this.saveXML()},this.loadButton.addEventListener("change",()=>{this.loadXML()}),this.resetBoard=get("#resetBoard"),this.EasyMQTT_bridge=get("#EasyMQTT_bridge"),this.term=get("#term"),this.file_status=get("#file-status"),this.put_file_select=get("#put-file-select"),this.file=get("#content_file_name"),this.content_file_name=get("#content_file_name"),this.put_file_select.onchange=()=>{Files.handle_put_file_select()},this.freeboard=""}}workspace.prototype.run=function(){this.runButton.status?mux.connected()?Tool.runPython():(Channel.mux.connect(),setTimeout(()=>{mux.connected()&&Tool.runPython()},2e3)):Tool.stopPython()},workspace.prototype.connecting=function(){this.toolbarButton.className="icon medium wait",this.channel_connect.className="wait"},workspace.prototype.connectClick=function(){mux.connected()?mux.disconnect():Channel.mux.connect()},workspace.prototype.receiving=function(){this.channel_connect.className="",this.runButton.status=!1,this.toolbarButton.className="icon medium on",this.connectButton.className="icon on",this.term.className="on"},workspace.prototype.runAbort=function(){this.channel_connect.className="",this.runButton.status=!0,this.toolbarButton.className="icon medium",this.connectButton.className="icon",this.term.className="",this.websocket.url.disabled=!1,this.connectButton.value="Connect"},workspace.prototype.change=function(){if(this.selector.value in this.devices){let e=this.devices.default_basic;if(e.toolbox?xhrGET(`toolbox/${e.toolbox}`,"document",e=>{Code.reloadToolbox(e)}):(xhrGET(`toolbox/${this.defaultToolbox}`,"document",e=>{Code.reloadToolbox(e)}),UI.notify.send(MSG.noToolbox)),"Object"==this.devices.constructor.name){let e=Code.workspace.getBlocksByType("pinout");Code.workspace.getBlocksByType("pinout").forEach((e,t)=>{e.refresh()}),0!=e.length&&UI.notify.send(MSG.wrongDevicePin)}Channel.webserial.packetSize=parseInt(e.serial_packet_size),Channel.webserial.speed=parseInt(e.speed)}else UI.notify.send(MSG.invalidDevice)},workspace.prototype.changeTo=function(e){e in this.devices?(this.selector.value=e,this.change()):""!=e&&UI.notify.send(MSG.deviceUnavailable.replace("%1",e))},workspace.prototype.saveXML=function(e){let t="";null==e?(t=Blockly.Xml.domToPrettyText(Blockly.Xml.workspaceToDom(Code.workspace)),t=this.writeWorkspace(t,!0)):t=Blockly.Xml.domToPrettyText(Blockly.Xml.textToDom(localStorage[e]));let o="data:x-application/xml;charset=utf-8,"+encodeURIComponent(t),s=document.createElement("a");s.setAttribute("href",o),s.setAttribute("download","workspace.bipes.xml"),s.style.display="none",document.body.appendChild(s),s.click(),document.body.removeChild(s)},workspace.prototype.readWorkspace=function(e,t){let o;if(o=t?/(<workspace>.*<\/workspace>\n)/s:/(<workspace>.*<\/workspace>)/,o.test(e)){let t=e.match(o)[0];e=e.replace(o,"");try{t.match(/<field name="TIMESTAMP">(.+?)<\/field>/)[1]}catch(e){UI.notify.log(e)}try{let e=t.match(/<freeboard><!\[CDATA\[(.+?)\]\]><\/freeboard>/)[1];this.loadFreeboard(e)}catch(e){UI.notify.log(e)}try{let e=t.match(/<databoard><!\[CDATA\[(.+?)\]\]><\/databoard>/)[1];this.loadDataboard(e)}catch(e){UI.notify.log(e)}try{let e=t.match(/<field name="DEVICE">(.+?)<\/field>/)[1];if("Object"==this.devices.constructor.name)this.changeTo(e);else var s=setInterval(()=>{"Object"==this.devices.constructor.name&&(this.changeTo(e),clearInterval(s))},500)}catch(e){UI.notify.log(e)}}else this.changeTo(Object.keys(this.devices)[0]);return e},workspace.prototype.writeWorkspace=function(e,t){let o=+new Date,s=this.selector.value,n="",i="";try{n=JSON.stringify(window.frames[1].freeboard.serialize()),'{"version":1,"allow_edit":true,"plugins":[],"panes":[],"datasources":[{"name":"vars","type":"core_scratchpad_plugin","settings":{"data":"={}","persist":"off","lock":false}}],"columns":3}'==n&&(n="")}catch(e){}try{i=window.frames[3].modules.Workspaces.compress()}catch(e){}return e=e.replace(/(xmlns=")(?:.+?)(")/g,"$1https://bipes.net.br$2"),e=t?e.replace(/(<xml xmlns=".+?">\n)/,`$1  <workspace>\n    <field name="DEVICE">${s}</field>\n    <field name="TIMESTAMP">${o}</field>\n    <freeboard><![CDATA[${n}]]></freeboard>\n    <databoard><![CDATA[${i}]]></databoard> \n  </workspace>\n`):e.replace(/(<xml xmlns=".+?">)/,`$1<workspace><field name="DEVICE">${s}</field><field name="TIMESTAMP">${o}</field><freeboard><![CDATA[${n}]]></freeboard><databoard><![CDATA[${i}]]></databoard></workspace>`)},workspace.prototype.loadXML=function(){if(null!=this.loadButton.files[0]){let e=this.loadButton.files[0];if(/.xml$/.test(e.name)&&"text/xml"==e.type){let t=new FileReader;t.readAsText(e,"UTF-8");t.onload=t=>{let o=this.readWorkspace(t.target.result,!0);try{let e=Blockly.Xml.textToDom(o);Blockly.Xml.domToWorkspace(e,Code.workspace)}catch(t){return UI.notify.log(t),/Error: Variable id, (.*) is already in use\.$/.test(t)?UI.notify.send(`Unique variable is already in use, could not load ${e.name}.`):UI.notify.send(`Failed to parse data, could not load ${e.name}.`),void(this.loadButton.value="")}UI.notify.send(MSG.blocksLoadedFromFile.replace("%1",e.name)),this.loadButton.value=""}}else UI.notify.send("No valid file selected to load.")}},workspace.prototype.loadFreeboard=function(e){try{let o=JSON.parse(e);if(/\/freeboard/.test(window.frames[1].location.pathname))if("object"==typeof window.frames[1].freeboard)window.frames[1].freeboard.loadDashboard(o);else var t=setInterval(()=>{"object"==typeof window.frames[1].freeboard&&(window.frames[1].freeboard.loadDashboard(o),clearInterval(t))},500);else UI.notify.log("iFrame is not a freeboard")}catch(e){UI.notify.log(e)}},workspace.prototype.loadDataboard=function(e){try{let o=JSON.parse(e);if(/\/databoard/.test(window.frames[3].location.pathname))if("object"==typeof window.frames[3].modules)window.frames[3].modules.Workspaces.deinit(),window.frames[3].modules.Workspaces.clearLocalStorage(),window.frames[3].modules.Workspaces.uncompress(o),get("#tab_databoard").classList.contains("on")&&window.frames[3].modules.Workspaces.init();else var t=setInterval(()=>{"object"==typeof window.frames[3].mopdules&&(window.frames[3].modules.Workspaces.deinit(),window.frames[3].modules.Workspaces.clearLocalStorage(),window.frames[3].modules.Workspaces.uncompress(o),clearInterval(t))},500);else UI.notify.log("iFrame is not a Databoard")}catch(e){UI.notify.log(e)}};
/*! For license information please see storage.js.LICENSE.txt */
"use strict";var BlocklyStorage={backupBlocks_:function(e){if("localStorage"in window){var t=e||Blockly.getMainWorkspace(),o=Blockly.Xml.workspaceToDom(t),l=Blockly.Xml.domToText(o);l=UI.workspace.writeWorkspace(l,!1),localStorage.setItem(UI.account.currentProject.uid,l),localStorage.setItem("bipes_projects",JSON.stringify(UI.account.projects))}},backupOnUnload:function(e){var t=e||Blockly.getMainWorkspace();window.addEventListener("unload",function(){BlocklyStorage.backupBlocks_(t)},!1)},restoreBlocks:function(e){if("localStorage"in window&&localStorage.bipes_projects&&"[]"!=localStorage.bipes_projects)try{let e=JSON.parse(localStorage.bipes_projects);UI.account.restoreProjects(e)}catch(e){UI.notify.log(e)}},link:function(e){var t=e||Blockly.getMainWorkspace(),o=Blockly.Xml.workspaceToDom(t,!0);if(1==t.getTopBlocks(!1).length&&o.querySelector){var l=o.querySelector("block");l&&(l.removeAttribute("x"),l.removeAttribute("y"))}var a=Blockly.Xml.domToText(o);a=UI.workspace.writeWorkspace(a,!1),BlocklyStorage.makeRequest_("/storage","xml",a,t)},retrieveXml:function(e,t){var o=t||Blockly.getMainWorkspace();BlocklyStorage.makeRequest_("/storage","key",e,o)},httpRequest_:null,makeRequest_:function(e,t,o,l){BlocklyStorage.httpRequest_&&BlocklyStorage.httpRequest_.abort(),BlocklyStorage.httpRequest_=new XMLHttpRequest,BlocklyStorage.httpRequest_.name=t,BlocklyStorage.httpRequest_.onreadystatechange=BlocklyStorage.handleRequest_,BlocklyStorage.httpRequest_.open("POST",e),BlocklyStorage.httpRequest_.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),BlocklyStorage.httpRequest_.send(t+"="+encodeURIComponent(o)),BlocklyStorage.httpRequest_.workspace=l},handleRequest_:function(){if(4==BlocklyStorage.httpRequest_.readyState){if(200!=BlocklyStorage.httpRequest_.status)BlocklyStorage.alert(BlocklyStorage.HTTPREQUEST_ERROR+"\nhttpRequest_.status: "+BlocklyStorage.httpRequest_.status);else{var e=BlocklyStorage.httpRequest_.responseText.trim();"xml"==BlocklyStorage.httpRequest_.name?(window.location.hash=e,BlocklyStorage.alert(BlocklyStorage.LINK_ALERT.replace("%1",window.location.href))):"key"==BlocklyStorage.httpRequest_.name&&(e.length?(UI.account.importProject(e),UI.notify.send("Project imported from link!")):BlocklyStorage.alert(BlocklyStorage.HASH_ERROR.replace("%1",window.location.hash))),BlocklyStorage.monitorChanges_(BlocklyStorage.httpRequest_.workspace)}BlocklyStorage.httpRequest_=null}},monitorChanges_:function(e){var t=Blockly.Xml.workspaceToDom(e),o=Blockly.Xml.domToText(t);e.addChangeListener(function t(){var l=Blockly.Xml.workspaceToDom(e),a=Blockly.Xml.domToText(l);o!=a&&(window.location.hash="",e.removeChangeListener(t))})},loadXml_:function(e,t){e=UI.workspace.readWorkspace(e,!1);try{e=Blockly.Xml.textToDom(e)}catch(t){return void BlocklyStorage.alert(BlocklyStorage.XML_ERROR+"\nXML: "+e)}t.clear(),Blockly.Xml.domToWorkspace(e,t)},alert:function(e){window.alert(e)}};